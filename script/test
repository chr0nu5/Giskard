#!/usr/bin/env bash
# Autogenerated script, compiled from the Bish language.
# Bish version 0.1
# Please see https://github.com/tdenniston/bish for more information about Bish.

function bish_log () {
    bish_println "script/test: $1";
}

function bish_lint () {
    find $1 -name '*.js' | xargs node_modules/.bin/jshint -c $2;
}

function bish_ensureStandard () {
    node_modules/.bin/jscs --config=script/stub/jscs-config.json $1;
}

function bish_exit () {
    exit $1;
}

function bish_main () {
    coreConf="script/stub/jshint-core.js";
    modulesConf="script/stub/jshint-modules.js";
    sampleText="This is a sample command description that will be parsed";
    if [[ $([[ $(bish_exists "node_modules/.bin/jshint") -eq 0 ]] && echo 1 || echo 0) -eq 1 ]]; then
        bish_log "Cannot find jshint. Did you run npm install?";
        bish_exit 1;
    fi;
    if [[ $([[ $(bish_exists "node_modules/.bin/jscs") -eq 0 ]] && echo 1 || echo 0) -eq 1 ]]; then
        bish_log "Cannot find jscs. Did you run npm install?";
        bish_exit 1;
    fi;
    bish_log "Linting core files...";
    bish_lint "src" "$coreConf";
    if [[ $([[ $(bish_success) -eq 0 ]] && echo 1 || echo 0) -eq 1 ]]; then
        bish_log "Errors found linting core files.";
        bish_exit 1;
    else
        bish_log "Linting module files...";
        bish_lint "bot_modules" "$modulesConf";
        if [[ $([[ $(bish_success) -eq 0 ]] && echo 1 || echo 0) -eq 1 ]]; then
            bish_log "Errors found linting module files.";
            bish_exit 1;
        else
            bish_log "Checking core files structure...";
            bish_ensureStandard "src";
            if [[ $([[ $(bish_success) -eq 0 ]] && echo 1 || echo 0) -eq 1 ]]; then
                bish_log "Errors found on core structures.";
                bish_exit 1;
            else
                bish_log "Checking modules files structure...";
                bish_ensureStandard "bot_modules";
                if [[ $([[ $(bish_success) -eq 0 ]] && echo 1 || echo 0) -eq 1 ]]; then
                    bish_log "Errors foudn on module structures.";
                    bish_exit 1;
                else
                    bish_log "Proofing module files...";
                    result=$(grep -l "$sampleText" bot_modules/*.js);
                    if [[ $([[ $(bish_success) -eq 1 ]] && echo 1 || echo 0) -eq 1 ]]; then
                        bish_log "One or more modules contains sample documentation that must be replaced by";
                        bish_log "the one regarding the module itself or removed:";
                        bish_println;
                        bish_println $(echo $result);
                        bish_println;
                        bish_log "Please fix this issue before proceeding.";
                        bish_exit 1;
                    else
                        bish_log "Everything looks awesome.";
                        bish_exit 0;
                    fi;
                fi;
            fi;
        fi;
    fi;
}

function bish_exists () {
    test -e $1;
    echo $(bish_success); exit;
}

function bish_println () {
    echo -e "$1";
}

function bish_success () {
    rc=$(echo $?);
    if [[ $([[ $rc -eq 0 ]] && echo 1 || echo 0) -eq 1 ]]; then
        echo 1; exit;
    else
        echo 0; exit;
    fi;
}

bish_main;

